<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>創作掲示板 - スレッド一覧</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>創作掲示板</h1>
        <nav>
            <a href="index.html">スレッド一覧</a>
            <a href="create_thread.html">スレッド作成</a>
        </nav>
    </header>

    <main>
        <section class="search-sort-filter">
            <h2>スレッド検索・絞り込み</h2>
            <input type="text" name="keyword" placeholder="タイトル検索"style="width: 50%;">
            <br>
            <select>
                <option value="updated_at">現行スレ</option>
                <option value="hearts">過去ログ</option>
            </select>
            <select name="sort_by">
                <option value="updated_at">更新順</option>
                <option value="hearts">ハート数順</option>
                <option value="responses">レス数順</option>
            </select>
            <br>
            <select>
                <option value="updated_at">タイトル部分一致</option>
                <option value="hearts">タイトル完全一致</option>
            </select>
            <select>
                <option value="updated_at">タグ部分一致</option>
                <option value="hearts">タグ完全一致</option>
            </select>


<div>
    <label for="recommended-tags">推奨タグ(最大20個):</label>
    <select id="recommended-tags" name="recommended_tags_select">
        <optgroup label="作品の種類">
            <option value="アニメ">アニメ</option>
            <option value="漫画">漫画</option>
            <option value="絵本">絵本</option>
            <option value="工作">工作</option>
            <option value="小説">小説</option>
            <option value="映画">映画</option>
            <option value="音楽">音楽</option>
            <option value="芸能">芸能</option>
            <option value="立体造形">立体造形</option>
            <option value="アート">アート</option>
            <option value="ダンス">ダンス</option>
            <option value="ゲーム">ゲーム</option>
            <option value="ソシャゲ">ソシャゲ</option>
            <option value="カードゲーム">カードゲーム</option>
            <option value="プログラム">プログラム</option>
            <option value="アスキーアート">アスキーアート</option>
            <option value="アナログ">アナログ</option>
            <option value="デジタル">デジタル</option>
            <option value="手作業">手作業</option>
            <option value="AI">AI</option>
            <option value="2D">2D</option>
            <option value="3D">3D</option>
            <option value="VR">VR</option>
            <option value="VTuber">VTuber</option>
        </optgroup>
        <optgroup label="物語のジャンル">
            <option value="RPG">RPG</option>
            <option value="TRPG">TRPG</option>
            <option value="ギャグ">ギャグ</option>
            <option value="ヒーロー">ヒーロー</option>
            <option value="サスペンス">サスペンス</option>
            <option value="ミステリー">ミステリー</option>
            <option value="ホラー">ホラー</option>
            <option value="デスゲーム">デスゲーム</option>
            <option value="バトルロイヤル">バトルロイヤル</option>
            <option value="ファンタジー">ファンタジー</option>
            <option value="ロボ">ロボ</option>
            <option value="ラブコメ">ラブコメ</option>
            <option value="日常">日常</option>
            <option value="アクション">アクション</option>
            <option value="スポーツ">スポーツ</option>
            <option value="アイドル">アイドル</option>
            <option value="ポストアポカリプス">ポストアポカリプス</option>
            <option value="ディストピア">ディストピア</option>
            <option value="サバイバル">サバイバル</option>
            <option value="カニバリズム">カニバリズム</option>
            <option value="ゾンビ">ゾンビ</option>
            <option value="クトゥルフ">クトゥルフ</option>
            <option value="サイバーパンク">サイバーパンク</option>
            <option value="タイムトラベル">タイムトラベル</option>
            <option value="ノンフィクション">ノンフィクション</option>
            <option value="メタフィクション">メタフィクション</option>
            <option value="学園">学園</option>
            <option value="料理">料理</option>
            <option value="政治">政治</option>
            <option value="宗教">宗教</option>
            <option value="科学">科学</option>
            <option value="医学">医学</option>
            <option value="宇宙">宇宙</option>
            <option value="怪獣">怪獣</option>
            <option value="異能">異能</option>
            <option value="格闘">格闘</option>
            <option value="冒険">冒険</option>
            <option value="追放">追放</option>
            <option value="戦争">戦争</option>
            <option value="犯罪">犯罪</option>
            <option value="群像劇">群像劇</option>
            <option value="転生転移">転生転移</option>
            <option value="成り上がり">成り上がり</option>
            <option value="if">if</option>
            <option value="クロスオーバー">クロスオーバー</option>
            <option value="デウス・エクス・マキナ">デウス・エクス・マキナ</option>
            <option value="ハーレム">ハーレム</option>
            <option value="NTR">NTR</option>
            <option value="純愛">純愛</option>
            <option value="強姦">強姦</option>
            <option value="異種姦">異種姦</option>
            <option value="近親相姦">近親相姦</option>
            <option value="ガールズラブ">ガールズラブ</option>
            <option value="ボーイズラブ">ボーイズラブ</option>
        </optgroup>
        <optgroup label="世界観">
            <option value="シェアワールド">シェアワールド</option>
            <option value="日本">日本</option>
            <option value="中華">中華</option>
            <option value="西洋">西洋</option>
            <option value="東洋">東洋</option>
            <option value="架空史">架空史</option>
            <option value="世界史">世界史</option>
            <option value="現代">現代</option>
            <option value="近世">近世</option>
            <option value="中世">中世</option>
            <option value="古代">古代</option>
            <option value="原始">原始</option>
            <option value="神話">神話</option>
            <option value="多次元">多次元</option>
            <option value="他惑星">他惑星</option>
            <option value="異世界">異世界</option>
        </optgroup>
        <optgroup label="創作の性質">
            <option value="一次創作">一次創作</option>
            <option value="二次創作">二次創作</option>
            <option value="三次創作">三次創作</option>
            <option value="女性向け">女性向け</option>
            <option value="男性向け">男性向け</option>
            <option value="シリーズもの">シリーズもの</option>
        </optgroup>
        <optgroup label="内容のレーティング">
            <option value="全年齢">全年齢</option>
            <option value="下ネタ">下ネタ</option>
            <option value="微エロ">微エロ</option>
            <option value="微グロ">微グロ</option>
            <option value="R18">R18</option>
            <option value="R18G">R18G</option>
        </optgroup>
        <optgroup label="ブランド">
            <option value="少年ジャンプ">少年ジャンプ</option>
            <option value="少年サンデー">少年サンデー</option>
            <option value="少年マガジン">少年マガジン</option>
            <option value="Fate">Fate</option>
            <option value="特撮">特撮</option>
            <option value="SCP">SCP</option>
            <option value="やる夫">やる夫</option>
            <option value="フロム">フロム</option>
            <option value="ソニー">ソニー</option>
            <option value="任天堂">任天堂</option>
        </optgroup>
        <optgroup label="その他">
            <option value="おすすめ教えて">おすすめ教えて</option>
            <option value="知識教えて">知識教えて</option>
            <option value="感想教えて">感想教えて</option>
            <option value="共感求む">共感求む</option>
            <option value="専門知識">専門知識</option>
            <option value="最強議論">最強議論</option>
            <option value="社会科学">社会科学</option>
            <option value="人文科学">人文科学</option>
            <option value="応用科学">応用科学</option>
            <option value="形式科学">形式科学</option>
            <option value="自然科学">自然科学</option>
            <option value="独自設定">独自設定</option>
            <option value="性転換">性転換</option>
            <option value="社会人">社会人</option>
            <option value="初めて">初めて</option>
            <option value="卒業">卒業</option>
            <option value="脳死">脳死</option>
            <option value="雑談">雑談</option>
            <option value="質問">質問</option>
            <option value="考察">考察</option>
            <option value="打線">打線</option>
            <option value="対戦">対戦</option>
            <option value="動物">動物</option>
            <option value="変態">変態</option>
            <option value="性癖">性癖</option>
            <option value="偉人">偉人</option>
            <option value="奇跡">奇跡</option>
            <option value="警告">警告</option>
            <option value="急募">急募</option>
            <option value="曇らせ">曇らせ</option>
            <option value="安価">安価</option>
            <option value="実況">実況</option>
            <option value="あんこ">あんこ</option>
            <option value="ダイス">ダイス</option>
            <option value="オリキャラ">オリキャラ</option>
            <option value="レビュー">レビュー</option>
            <option value="パソコン">パソコン</option>
            <option value="テスト">テスト</option>
            <option value="コラボ">コラボ</option>
            <option value="ガチャ">ガチャ</option>
            <option value="パロディ">パロディ</option>
            <option value="コラージュ">コラージュ</option>
            <option value="ネットミーム">ネットミーム</option>
            <option value="ネタバレ注意">ネタバレ注意</option>
            <option value="俺TUEEE">俺TUEEE</option>
            <option value="俺YOEEE">俺YOEEE</option
        </optgroup>

    </select>
    <br>
    <button type="button" onclick="recommendATagAdd(this)"id="recommendTagButton">推奨タグを追加</button>
    <button type="button" onclick="pickRandom(this)"id="recommendTagRandomButton">ランダム追加</button>
</div>


            <label for="tagAddButton">自由記述タグ(最大20個):</label>
            <br>
            <button id="tagAddButton"onclick="tagAdd(this)"type="button">タグを追加</button>
            <div id="inputContainer"></div>


                    <button type="submit" style="margin-top: 5px;">検索</button>
                    <button type="submit" style="margin-top: 5px;">お気に入りスレを表示</button>
                    <button type="submit" style="margin-top: 5px;">作成したスレを表示</button>
                </form>
        </section>

        <section class="thread-list">
        </section>
        <div class="container">
            <h1>クッキーログイン状態デモ</h1>
    
            <button id="login-btn">ログイン (クッキー設定)</button>
            <button id="logout-btn">ログアウト (クッキー解除)</button>
            <button id="check-status-btn">状態を確認</button>
    
            <div id="status">現在の状態: 不明</div>
            <p class="cookie-info">
                注意: これは実際の認証システムではありません。クッキーを使った簡易的な状態管理のデモです。
                ブラウザの開発者ツールでクッキーの変更を確認できます。<br>
                ローカル環境 (http://localhost, file:///) では、Secure属性は効果がないか、クッキーが保存されないことがあります。
            </p>
        </div>
     
    </main>



    <footer>
        <p>© 2024 あなたの掲示板</p>
    </footer>
    <script src="tag.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const loginButton = document.getElementById('login-btn');
    const logoutButton = document.getElementById('logout-btn');
    const checkStatusButton = document.getElementById('check-status-btn');
    const statusDisplay = document.getElementById('status');

    const LOGIN_COOKIE_NAME = 'isUserLoggedInDemoSecureTest'; // クッキー名を少し変更してテストしやすく
    const LOGIN_COOKIE_VALUE = 'true';
    const COOKIE_EXPIRATION_DAYS = 7;

    /**
     * 指定された名前のクッキーの値を取得します。
     * @param {string} name 取得したいクッキーの名前。
     * @returns {string|null} クッキーの値。見つからない場合は null を返します。
     */
    function getCookie(name) {
        if (typeof document === 'undefined' || !document.cookie) {
            return null;
        }
        const nameEQ = encodeURIComponent(name) + "="; // ★ 名前のエンコードも考慮
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1, c.length);
            }
            if (c.indexOf(nameEQ) === 0) {
                let value = c.substring(nameEQ.length, c.length);
                try {
                    return decodeURIComponent(value);
                } catch (e) {
                    console.warn(`Failed to decode cookie value for ${name}:`, value, e);
                    return value; // デコード失敗時はそのまま
                }
            }
        }
        return null;
    }

    /**
     * クッキーを設定します。
     * @param {string} name 設定するクッキーの名前。
     * @param {string} value 設定するクッキーの値。
     * @param {object} [options={}] クッキーのオプション。
     * @param {number} [options.days] 有効期限（日数）。指定しない場合はセッションクッキー。
     * @param {string} [options.path='/'] クッキーが有効なパス。デフォルトはルートパス。
     * @param {string} [options.domain] クッキーが有効なドメイン。
     * @param {boolean|'auto'} [options.secure='auto'] HTTPS接続でのみ送信するかどうか。'auto'ならHTTPS時のみ。
     * @param {'Strict'|'Lax'|'None'} [options.sameSite='Lax'] SameSite属性。
     */
    function setCookie(name, value, options = {}) {
        if (typeof document === 'undefined') {
            return;
        }

        let cookieString = encodeURIComponent(name) + "=" + encodeURIComponent(value);

        if (typeof options.days === 'number') {
            if (options.days === 0) { // 0日は即時削除
                cookieString += "; Max-Age=0";
            } else {
                // Max-Ageは秒単位なので日数から変換
                cookieString += "; Max-Age=" + (options.days * 24 * 60 * 60);
                // Expiresも設定しておくと古いブラウザにも対応できる (Max-Age優先)
                const date = new Date();
                date.setTime(date.getTime() + (options.days * 24 * 60 * 60 * 1000));
                cookieString += "; expires=" + date.toUTCString();
            }
        }
        // options.days が undefined ならセッションクッキー (Max-Age/Expiresなし)

        cookieString += "; path=" + (options.path || "/");

        if (options.domain && typeof options.domain === 'string' && options.domain.trim() !== '') {
            cookieString += "; domain=" + options.domain.trim();
        }

        let applySecure = false;
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isFileProtocol = window.location.protocol === 'file:';

        if (options.secure === true) {
            applySecure = true;
        } else if (options.secure === 'auto' && window.location.protocol === 'https:') {
            applySecure = true;
        }
        // options.secure が false または 'auto' で HTTP の場合は applySecure は false のまま

        // ローカル開発環境ではSecure属性を強制的に無効化（または警告）する
        if ((isLocalhost && window.location.protocol === 'http:') || isFileProtocol) {
            if (applySecure) { // HTTPSでしか機能しないSecureをHTTPで設定しようとした場合
                console.warn(
                    `Secure attribute for cookie "${name}" was requested but is being omitted ` +
                    `because the page is served over HTTP on localhost or as a local file. ` +
                    `Secure cookies are only effective over HTTPS.`
                );
            }
            applySecure = false; // ローカルHTTP/FileではSecureを強制的に無効
        }


        const sameSiteValue = options.sameSite || 'Lax'; // デフォルトはLax
        if (['Strict', 'Lax', 'None'].includes(sameSiteValue)) {
            cookieString += "; SameSite=" + sameSiteValue;
            if (sameSiteValue === 'None') {
                if (!applySecure) {
                    // SameSite=None は Secure 属性が必須
                    console.error(
                        `Cookie "${name}" with SameSite=None requires the Secure attribute. ` +
                        `Since Secure is not being applied (e.g., page not served over HTTPS or Secure option is false/auto on HTTP), ` +
                        `this cookie may be rejected by the browser or treated as SameSite=Lax. ` +
                        `Ensure your site is served over HTTPS when using SameSite=None.`
                    );
                    // ブラウザによってはこのクッキーが設定されない、または無視される
                }
            }
        } else {
            console.warn(`Invalid SameSite value: "${options.sameSite}". Defaulting to Lax for cookie "${name}".`);
            cookieString += "; SameSite=Lax";
        }

        if (applySecure) {
            cookieString += "; Secure";
        }

        document.cookie = cookieString;
        console.log(`Attempted to set cookie: "${cookieString}" (Check developer tools to verify)`);
    }

    /**
     * 指定された名前のクッキーを削除します。
     * @param {string} name 削除したいクッキーの名前。
     * @param {object} [options={}] クッキーのオプション (path, domain が必要)。
     * @param {string} [options.path='/'] クッキーが設定されたパス。
     * @param {string} [options.domain] クッキーが設定されたドメイン。
     */
    function deleteCookie(name, options = {}) {
        // 削除は実質、有効期限を過去にするかMax-Age=0にする
        // 設定時と同じpath, domain, secure, samesite を指定する必要がある場合がある
        const deleteOptions = {
            days: 0, // Max-Age=0 となる
            path: options.path || '/',
            domain: options.domain || undefined, // domainが空なら設定しない
            secure: options.secure, // 設定時と同じ値を渡す
            sameSite: options.sameSite // 設定時と同じ値を渡す
        };
        setCookie(name, '', deleteOptions); // 値は空で、Max-Age=0
        console.log(`Attempted to delete cookie "${name}" with options:`, deleteOptions);
    }

    // --- ログイン状態を更新・表示する関数 ---
    function updateLoginStatusDisplay() {
        const isLoggedIn = getCookie(LOGIN_COOKIE_NAME) === LOGIN_COOKIE_VALUE;
        if (isLoggedIn) {
            statusDisplay.textContent = '現在の状態: ログイン中 (クッキーあり)';
            statusDisplay.style.backgroundColor = '#d4edda';
            statusDisplay.style.borderColor = '#c3e6cb';
        } else {
            statusDisplay.textContent = '現在の状態: ログアウト中 (クッキーなし)';
            statusDisplay.style.backgroundColor = '#f8d7da';
            statusDisplay.style.borderColor = '#f5c6cb';
        }
    }

    // --- イベントリスナー ---
    if (loginButton) {
        loginButton.addEventListener('click', () => {
            setCookie(LOGIN_COOKIE_NAME, LOGIN_COOKIE_VALUE, {
                days: COOKIE_EXPIRATION_DAYS,
                secure: 'auto', // HTTPSならSecure, HTTPならSecureなし (ローカル開発考慮)
                sameSite: 'Lax'
            });
            alert('「ログイン」しました (クッキーを設定しようとしました)。\n開発者ツールで確認してください。');
            updateLoginStatusDisplay();
        });
    }

    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            // 削除時も、設定時と同じ path, domain, secure, samesite を考慮する必要がある
            // (ただし、secure や samesite はブラウザの解釈による部分もある)
            // ここでは path のみを明示的に指定し、他は setCookie 内のデフォルトやロジックに任せる
            deleteCookie(LOGIN_COOKIE_NAME, {
                path: '/', // 設定時と合わせる
                secure: 'auto', // 設定時と合わせる
                sameSite: 'Lax' // 設定時と合わせる
            });
            alert('「ログアウト」しました (クッキーを削除しようとしました)。');
            updateLoginStatusDisplay();
        });
    }

    if (checkStatusButton) {
        checkStatusButton.addEventListener('click', () => {
            updateLoginStatusDisplay(); // まず表示を更新
            const isLoggedIn = getCookie(LOGIN_COOKIE_NAME) === LOGIN_COOKIE_VALUE;
            if (isLoggedIn) {
                alert('現在、ログイン状態です (クッキーが設定されています)。');
            } else {
                alert('現在、ログアウト状態です (クッキーはありません、または読み取れません)。');
            }
        });
    }

    // 初期表示
    updateLoginStatusDisplay();
});
</script>
</body>
</html>